services:
  backend:
    image: ghcr.io/seanonet/rtlsdr-radio-backend:latest
    container_name: rtlsdr-backend
    restart: unless-stopped
    privileged: true
    devices:
      - /dev/bus/usb:/dev/bus/usb
    volumes:
      - rtlsdr-data:/app/data
    environment:
      - EXTERNAL_STREAM_URL=${EXTERNAL_STREAM_URL:-}
    ports:
      - "127.0.0.1:8001:8000" # Local only for Music Assistant (8001->8000)
      - "127.0.0.1:8090:8089" # Stream port for local access (8090->8089)
    networks:
      - proxy
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"

      # API Router
      - "traefik.http.routers.rtlsdr-api.rule=Host(`radio.local.seanonet.dev`) && PathPrefix(`/api`)"
      - "traefik.http.routers.rtlsdr-api.entrypoints=https"
      - "traefik.http.routers.rtlsdr-api.tls=true"
      - "traefik.http.routers.rtlsdr-api.service=rtlsdr-api"
      - "traefik.http.services.rtlsdr-api.loadbalancer.server.port=8000"

      # Stream Router (for Chromecast)
      - "traefik.http.routers.rtlsdr-stream.rule=Host(`radio-stream.local.seanonet.dev`)"
      - "traefik.http.routers.rtlsdr-stream.entrypoints=https"
      - "traefik.http.routers.rtlsdr-stream.tls=true"
      - "traefik.http.routers.rtlsdr-stream.service=rtlsdr-stream"
      - "traefik.http.services.rtlsdr-stream.loadbalancer.server.port=8089"

  frontend:
    image: ghcr.io/seanonet/rtlsdr-radio-frontend:latest
    container_name: rtlsdr-frontend
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      - proxy
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"

      # Frontend Router
      - "traefik.http.routers.rtlsdr.rule=Host(`radio.local.seanonet.dev`)"
      - "traefik.http.routers.rtlsdr.entrypoints=https"
      - "traefik.http.routers.rtlsdr.tls=true"
      - "traefik.http.routers.rtlsdr.service=rtlsdr"
      - "traefik.http.services.rtlsdr.loadbalancer.server.port=80"

  music-assistant:
    image: ghcr.io/seanonet/rtlsdr-music-assistant:latest
    container_name: music-assistant
    restart: unless-stopped
    depends_on:
      - backend
    network_mode: host
    cap_add:
      - SYS_ADMIN
      - DAC_READ_SEARCH
    security_opt:
      - apparmor:unconfined
    volumes:
      - music-assistant-data:/data
    environment:
      - LOG_LEVEL=info

networks:
  proxy:
    external: true
volumes:
  rtlsdr-data:
  music-assistant-data:
