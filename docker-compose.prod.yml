services:
  backend:
    image: ghcr.io/seanonet/rtlsdr-radio-backend:latest
    container_name: rtlsdr-backend
    restart: unless-stopped
    privileged: true
    network_mode: host  # Required for Chromecast mDNS discovery
    devices:
      - /dev/bus/usb:/dev/bus/usb
    volumes:
      - /mnt/user/appdata/rtlsdr-radio/data:/app/data
      - /mnt/user/appdata/rtlsdr-radio/logos:/app/app/static/images/stations
    environment:
      - EXTERNAL_STREAM_URL=${EXTERNAL_STREAM_URL:-}
      - DEFAULT_STATIONS=${DEFAULT_STATIONS:-all}  # Options: fm, dab, all, none
    # Note: ports not needed with network_mode: host (uses host ports directly)
    labels:
      # Enable Traefik (file-based config needed for host network services)
      - "traefik.enable=true"

      # API Router
      - "traefik.http.routers.rtlsdr-api.rule=Host(`radio.local.seanonet.dev`) && PathPrefix(`/api`)"
      - "traefik.http.routers.rtlsdr-api.entrypoints=https"
      - "traefik.http.routers.rtlsdr-api.tls=true"
      - "traefik.http.routers.rtlsdr-api.service=rtlsdr-api"
      - "traefik.http.services.rtlsdr-api.loadbalancer.server.url=http://host.docker.internal:9080"

      # Static Files Router (station logos)
      - "traefik.http.routers.rtlsdr-static.rule=Host(`radio.local.seanonet.dev`) && PathPrefix(`/static`)"
      - "traefik.http.routers.rtlsdr-static.entrypoints=https"
      - "traefik.http.routers.rtlsdr-static.tls=true"
      - "traefik.http.routers.rtlsdr-static.service=rtlsdr-api"

      # Stream Router (for Chromecast)
      - "traefik.http.routers.rtlsdr-stream.rule=Host(`radio-stream.local.seanonet.dev`)"
      - "traefik.http.routers.rtlsdr-stream.entrypoints=https"
      - "traefik.http.routers.rtlsdr-stream.tls=true"
      - "traefik.http.routers.rtlsdr-stream.service=rtlsdr-stream"
      - "traefik.http.services.rtlsdr-stream.loadbalancer.server.url=http://host.docker.internal:8089"

  frontend:
    image: ghcr.io/seanonet/rtlsdr-radio-frontend:latest
    container_name: rtlsdr-frontend
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      - proxy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"

      # Frontend Router
      - "traefik.http.routers.rtlsdr.rule=Host(`radio.local.seanonet.dev`)"
      - "traefik.http.routers.rtlsdr.entrypoints=https"
      - "traefik.http.routers.rtlsdr.tls=true"
      - "traefik.http.routers.rtlsdr.service=rtlsdr"
      - "traefik.http.services.rtlsdr.loadbalancer.server.port=80"
      - "godash.enable=true"
      - "godash.name=RTL-SDR Radio"
      - "godash.group=Media"
      - "godash.icon=radio"
      - "godash.description=FM Radio Receiver"

  music-assistant:
    image: ghcr.io/seanonet/rtlsdr-music-assistant:latest
    container_name: music-assistant
    restart: unless-stopped
    depends_on:
      - backend
    network_mode: host
    cap_add:
      - SYS_ADMIN
      - DAC_READ_SEARCH
    security_opt:
      - apparmor:unconfined
    volumes:
      - /mnt/user/appdata/rtlsdr-radio/music-assistant:/data
    environment:
      - LOG_LEVEL=info
    labels:
      # GoDash (explicit URL since host networking)
      - "godash.enable=true"
      - "godash.name=Music Assistant"
      - "godash.group=Media"
      - "godash.icon=music-assistant"
      - "godash.description=Whole Home Audio"
      - "godash.url=http://10.0.0.200:8095"

networks:
  proxy:
    external: true
